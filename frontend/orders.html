<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - CoinMrkt</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header>
        <div class="header-top">
            <div class="header-left"></div>
            <div class="header-center">
                <a href="/" class="logo-link"><h1>CoinMrkt</h1></a>
                <p>My Orders</p>
            </div>
            <div class="header-right">
                <div id="auth-status">
                    <span id="user-info"></span>
                    <a href="/" class="nav-btn">Shop</a>
                    <button onclick="logout()" class="nav-btn logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="orders-page">
        <h2>My Orders</h2>
        <div id="orders-list" class="orders-list"></div>
        <div id="no-orders" class="no-orders" style="display: none;">
            <p>You haven't placed any orders yet.</p>
            <a href="/" class="shop-link">Start Shopping</a>
        </div>
    </main>

    <script>
        let currentUser = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                if (!data.user) {
                    window.location.href = '/login';
                    return;
                }
                currentUser = data.user;
                document.getElementById('user-info').textContent = `Hi, ${currentUser.username}`;
                fetchOrders();
            } catch (error) {
                window.location.href = '/login';
            }
        }

        async function fetchOrders() {
            try {
                const response = await fetch('/api/orders');
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        function renderOrders(orders) {
            const ordersList = document.getElementById('orders-list');
            const noOrders = document.getElementById('no-orders');

            if (orders.length === 0) {
                ordersList.style.display = 'none';
                noOrders.style.display = 'block';
                return;
            }

            ordersList.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-id">Order #${order._id.slice(-8)}</span>
                        <div class="order-badges">
                            <span class="order-badge payment-${order.payment_status}">Payment: ${order.payment_status}</span>
                            <span class="order-badge status-${order.status}">Status: ${order.status}</span>
                        </div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item" onclick="viewCoin('${item.coin_id}')">
                                <img src="${item.coin?.image_url || 'https://via.placeholder.com/60x60?text=Coin'}" alt="${item.coin?.name || 'Coin'}">
                                <div class="order-item-info">
                                    <span class="order-item-name">${item.coin?.name || 'Unknown Coin'}</span>
                                    <span class="order-item-qty">Qty: ${item.quantity}</span>
                                </div>
                                <div class="order-item-price">
                                    $${item.coin ? (item.coin.price * item.quantity).toLocaleString() : '0'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-details">
                        <p><strong>Customer:</strong> ${order.customer_name}</p>
                        <p><strong>Email:</strong> ${order.customer_email}</p>
                        <p><strong>Payment Method:</strong> ${order.payment_method.toUpperCase()}</p>
                    </div>
                    <div class="order-total">
                        Total: $${order.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </div>
                </div>
            `).join('');
        }

        function viewCoin(coinId) {
            window.location.href = `/coin/${coinId}`;
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        }

        checkAuth();
    </script>
</body>
</html>
